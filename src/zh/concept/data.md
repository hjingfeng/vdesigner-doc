# 实时数据通信

实时数据通信，是物联网平台中必备的功能。可以实时、无刷新的将界面组件的重要属性值，如数据、文本、形状、行为、动画等进行双向传输和控制，实现设备数据实时监控、数据大屏展示以及数字孪生。

软件内置实时数据通信功能，能够远程服务器端发送给当前网页端的数据，实时更新到图纸上的一个或多个组件的属性值。图纸上的组件(s)，也能够根据事件规则的设定进行实施反馈和转发。

## 支持的协议

在 [简介](../guide/index.md#内置标准通信协议) 一节中，你已经了解到软件已内置3种通信协议
- Mqtt
- Websocket
- Http

无论你使用哪一种通信协议/方式，数据同步和更新的机制都是相同的。http采用的是定时(默认每秒请求1次)请求远程api，获取响应数据后，更新组件的指定属性。

## 实时通信业务流程/机制

主要通信流程如下：

- 建立连接
  ::: tip 提示
  每一张图纸，都可以配置单独的数据通信协议和相关的配置。在 [**工具栏**](../guide/designer-intro.md#界面介绍) 点击 [**图纸设定**](../guide/index.md#内置标准通信协议) 按钮进行设定。
  :::
- 监听数据
- 更新数据

## 4种实时数据更新的方式

无论采用哪一种协议和远程数据接口进行通信，在软件的监听和更新数据逻辑上，发送给UI端的数据结构上尽量循序下面三类：

- 按组件id，更新属性值
- 按组件标签，更新属性值
- 按数据绑定id，更新属性值

::: tip 提示
如果远程设备端/服务器端接口发送给UI端的数据结构不能够改变，比如已建设的系统软件。那么可以通过下方 [***自定义数据结构***] 一节说明的方式进行数据更新。
:::

数据结构，是一个json字符串，VDesigner 将通过上面介绍的3类通信协议，将接收到的这个字符串解析成json对象后，调用核心api来更新组件的属性值。

### 1、按组件id更新属性值的数据结构

一次更新一个属性值

``` json
{
  id: '79cf8947',
  text: '新的值'
}
```


一次更新多个属性值，结构是对象数组

``` json
[{
  id: 'pen1的id',
  text: 'new text'
},{
  id: 'pen1的id',
  text: 'new text'
}]

```

::: tip 提示
每个组件的id，可以通过右侧的 **数据设置面板** 查看并复制

![复制组件id](/images/concept/copy-id.gif)
:::

### 2、按组件标签更新属性值的数据结构

``` json
{
  tag: 'tag',      // tag的名字
  text: 'new text' // 属性及新的属性值
}

```

上面的数据结构，将更新所有tag = 'tag' 的组件的属性 text 的值 为： new text

### 3、按绑定的远程数据id更新数据的数据结构

``` json
{
  dataId: '远程某个数据的id',     
  value: 'value' 
}
```

dataId，代表了一个关联关系。它将某个数据点和图纸上的某个属性进行了关联。

例如：某个设备的电压(数据点)的id值是：id9527，通过关联操作（在 ***数据设置*** 面板中，将组件和远程的数据点进行关联），将其关联到id为 pen9527 的text属性。那么如果数据端/服务器接口端向UI端发送了如下数据：

``` json
{
  dataId: 'id9527',     
  value: '200' 
}
```

VDesigner 在收到数据后，将实时更新 id 为 pen9527 的 text 的值，为：200

### 4、自定义数据结构

::: tip 提示
对于集成已建设的系统软件的数据，由于其数据接口已经固化，或者更改数据结构从成本角度考虑并不可取，这类情况在将老系统接入VDesigner时，是大概率会发生的。
:::

你也可以采用自定义数据结构的方式来实现实时数据同步的解析规则定义，从而避免已建设的数字化系统的数据接口进行结构上的更改。

你所需要做的，是打开图纸的通讯设置面板。打开自定义数据处理js代码的输入窗口，输入自定义代码即可。

![自定义数据解析js](/images/concept/custom-js.gif)